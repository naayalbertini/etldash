<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Gest√£o - Festa da Fam√≠lia</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* VARI√ÅVEIS DE COR PARA TEMA GLASS/SOFISTICADO */
    :root {
      --bg-light: #f9f9f9;
      --bg-card: white;
      --text-dark: #333;
      --accent-color: #007bff; /* Azul prim√°rio */
      --header-color: #f1f1f1;
      --border-color: #e0e0e0;
      --reserved-color: #dc3545; /* Vermelho Padr√£o (Pendente) */
      --confirmed-color: #28a745; /* Verde Padr√£o (Confirmado) */
      
      /* Novas vari√°veis para o design de login */
      --glass-bg: rgba(255, 255, 255, 0.1); 
      --login-card-bg: white;
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      /* Fundo com gradiente suave e moderno */
      background: linear-gradient(135deg, #eef1f5 0%, #dcdfe4 100%);
      color: var(--text-dark);
      padding: 0; 
      margin: 0;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1300px;
      margin: 0 auto;
      background: var(--bg-card);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    
    /* ESTILOS ELEGANTES PARA A TELA DE LOGIN */
    #login-screen {
        display: none; 
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        /* Adiciona fundo suave para o login */
        background: linear-gradient(135deg, #eef1f5 0%, #dcdfe4 100%); 
    }
    
    .login-container {
        /* Card de login branco puro com sombra sofisticada */
        background: var(--login-card-bg); 
        padding: 50px 40px; 
        border-radius: 16px; 
        box-shadow: var(--shadow-soft); 
        width: 100%;
        max-width: 360px; 
        text-align: center;
        border: 1px solid #f0f0f0; 
    }

    .login-container h1 {
        color: var(--text-dark); 
        margin-bottom: 35px; 
        font-weight: 300; 
        font-size: 2.5em; 
        letter-spacing: 1px;
        border-bottom: none;
    }

    #login-screen input[type="email"], #login-screen input[type="password"] {
        width: 100%;
        padding: 14px 12px; 
        margin: 10px 0 20px 0;
        border: 1px solid #ccc; 
        border-radius: 8px; 
        box-sizing: border-box;
        font-size: 16px;
        background-color: #f7f7f7; 
        transition: all 0.3s;
    }
    #login-screen input:focus {
        border-color: var(--accent-color); 
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15); 
        outline: none;
        background-color: white; 
    }
    
    #login-screen button {
        background-color: var(--accent-color);
        color: white;
        padding: 15px 20px;
        margin: 15px 0 8px 0;
        border: none;
        border-radius: 8px; 
        cursor: pointer;
        width: 100%;
        font-size: 17px;
        font-weight: 500; 
        letter-spacing: 0.5px;
        transition: background-color 0.3s, box-shadow 0.2s;
        box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
    }

    #login-screen button:hover {
        background-color: #0056b3;
        box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3);
    }
    
    #error-message {
        color: var(--reserved-color);
        margin-top: 15px;
        font-weight: 500;
    }
    /* FIM: ESTILOS ELEGANTES PARA LOGIN */

    /* Estilos do Painel de Gest√£o */
    #dashboard-content {
        display: none; 
        padding: 20px;
    }
    .user-info {
        display: none; 
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 25px;
        font-size: 1.1rem;
    }
    .user-info span {
        display: flex;
        align-items: center;
        color: var(--text-dark);
    }
    
    /* NOVO ESTILO PARA A IMAGEM DE PERFIL */
    .profile-photo {
        width: 35px; /* Tamanho da foto */
        height: 35px;
        border-radius: 50%; /* Torna a foto redonda */
        margin-right: 10px;
        object-fit: cover; /* Garante que a imagem preencha o espa√ßo sem distorcer */
        border: 2px solid var(--accent-color); /* Borda sutil */
    }

    /* O estilo profile-icon n√£o √© mais necess√°rio, mas o mantemos para fallback ou estrutura */
    .user-info .profile-icon {
        font-size: 1.5rem;
        margin-right: 10px;
        color: var(--accent-color);
    }
    /* FIM NOVO ESTILO */

    .logout-button {
        background: none;
        border: 1px solid var(--reserved-color);
        color: var(--reserved-color);
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
    }
    .logout-button:hover {
        background-color: var(--reserved-color);
        color: white;
    }
    
    h1 {
      color: var(--text-dark);
      text-align: left;
      margin-bottom: 25px;
      font-weight: 300;
      font-size: 2em;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }
    
    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        gap: 10px; /* Reduzido o gap para 3 bot√µes */
    }
    .search-area {
        position: relative;
        flex-grow: 1;
    }
    #search-input {
      width: 100%;
      padding: 10px 10px 10px 45px;
      border: 1px solid var(--border-color);
      background-color: var(--bg-card);
      color: var(--text-dark);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    #search-input:focus {
        border-color: var(--accent-color);
        outline: none;
    }
    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2rem;
        color: #777;
    }
    .pdf-button {
        background-color: var(--reserved-color);
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: background-color 0.2s, transform 0.1s;
        white-space: nowrap; /* Impede quebras de linha em bot√µes na √°rea de trabalho */
    }
    .pdf-button:hover {
        background-color: #c82333;
        transform: translateY(-1px);
    }

    /* ESTILOS DA TABELA */
    
    #reservasTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: var(--bg-card);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }
    #reservasTable th, #reservasTable td {
      padding: 12px 10px; /* Padding reduzido para mais colunas */
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.85rem; /* Fonte ligeiramente menor */
    }
    #reservasTable th {
      background-color: var(--header-color);
      color: var(--text-dark);
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      position: relative;
      letter-spacing: 0.5px;
      white-space: nowrap; 
    }
    #reservasTable th:hover {
      background-color: #e9e9e9;
    }
    #reservasTable tbody tr:hover {
      background-color: #f5f5f5;
    }
    
    .sort-asc::after { color: var(--accent-color); content: ' ‚ñ≤'; font-size: 0.8em; }
    .sort-desc::after { color: var(--accent-color); content: ' ‚ñº'; font-size: 0.8em; }
    
    /* NOVO: DESTAQUE PARA MESAS */
    .mesa-highlight {
        font-weight: 700 !important;
        font-size: 1.1rem !important;
        background-color: #e3f2fd; /* Azul muito claro */
        color: var(--accent-color); /* Azul principal */
        border-radius: 4px;
        padding: 5px 8px !important;
        text-align: center !important;
        display: inline-block; /* Garante que o span se comporte como um bloco para o padding */
        min-width: 30px; /* Garante que todos os n√∫meros de mesas tenham um tamanho m√≠nimo */
    }
    
    /* NOVO: DESTAQUE PARA CADEIRAS EXTRAS */
    .cadeiras-highlight {
        font-weight: 700 !important;
        font-size: 1.1rem !important;
        background-color: #fff3e0; /* Amarelo muito claro */
        color: #e67e22; /* Laranja forte */
        border-radius: 4px;
        padding: 5px 8px !important;
        text-align: center !important;
        display: inline-block; /* Garante que o span se comporte como um bloco para o padding */
        min-width: 30px;
    }


    /* ESTILO DO BOT√ÉO DE LEMBRETE PIX */
    .pix-reminder-button { 
        background-color: #f39c12; 
        color: white;
        margin-left: 5px; 
        text-decoration: none; 
        padding: 4px 8px; 
        border-radius: 4px; 
        font-weight: bold; 
        font-size: 0.75rem; /* Ajustado */
        display: inline-block;
        white-space: nowrap; 
    }
    .pix-reminder-button:hover {
        background-color: #e67e22;
    }


    .status-badge {
        display: inline-block;
        padding: 5px 8px; /* Ajustado */
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.75rem; /* Ajustado */
    }
    /* Status PENDENTE agora √© VERMELHO */
    .status-pendente {
        background-color: #f8d7da; 
        color: var(--reserved-color);
    }
    /* Status CONFIRMADO agora √© VERDE */
    .status-confirmado {
        background-color: #d4edda; 
        color: var(--confirmed-color);
    }
    
    /* NOVO: DESTAQUE PARA CANCELAMENTO SOLICITADO */
    .status-cancelamento {
        background-color: #ffc107; 
        color: #333;
        border: 1px solid #e0a800;
    }
    
    /* ESTILO PARA ALINHAR BOT√ïES NA COLUNA A√á√ÉO (Vers√£o Desktop) - AGORA √â A 10¬™ COLUNA */
    #reservasTable td:nth-child(10) { 
        display: flex;
        flex-direction: column;
        gap: 5px;
        align-items: flex-start;
        padding-top: 10px;
        padding-bottom: 10px;
    }


    .action-button {
        color: white;
        border: none;
        padding: 8px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.8rem; /* Ajustado */
        transition: background-color 0.2s;
        margin: 2px 0;
        display: block; 
        width: 100%;
        text-align: center;
        white-space: nowrap;
    }
    .confirm-button {
        background-color: var(--accent-color);
    }
    .edit-button {
        background-color: #ffc107; 
        color: #333;
    }
    .delete-button {
        background-color: var(--reserved-color); 
    }
    .action-button:hover, .confirm-button:hover {
        opacity: 0.9;
    }

    .total-reservas {
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
      font-size: 1.1rem; /* Reduzido levemente para caber mais info */
      padding: 15px;
      background-color: #e0f7fa; 
      border-radius: 4px;
      color: #00796b;
      border: 1px solid #b2ebf2;
    }
    /* Destaque para o texto de mesas pagas */
    .total-reservas #totalMesasPagas, .total-reservas #valorTotalArrecadado { 
        color: var(--confirmed-color); 
        font-weight: 700; 
    }
    /* Destaque para o texto de Cadeiras Extras */
    .total-reservas #totalCadeirasExtras { 
        color: #e67e22; /* Laranja forte */ 
        font-weight: 700; 
    }
    
    .loading-text {
        color: #666;
        font-size: 1.1rem;
    }
    
    #editModal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }
    .modal-content-edit {
        background-color: var(--bg-card);
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .modal-content-edit label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--text-dark);
    }
    .modal-content-edit input, .modal-content-edit select {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
    }
    .modal-content-edit h2 {
        margin-top: 0;
        color: var(--text-dark);
    }
    .close-button {
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #aaa;
    }
    .close-button:hover {
        color: #333;
    }

    /* RESPONSIVIDADE (Novas Regras de Tabela em Card View) */
    @media (max-width: 768px) {
        body { padding: 0; }
        .container {
            padding: 15px;
            border-radius: 0;
            box-shadow: none;
            min-height: 100vh;
        }
        h1 {
            font-size: 1.8em;
        }
        .user-info {
             flex-direction: column;
             align-items: flex-start;
             padding-bottom: 10px;
        }
        .logout-button {
             margin-top: 10px;
             font-size: 0.9rem;
        }
        .actions-bar {
            flex-direction: column;
            gap: 10px;
        }
        .search-area, .pdf-button {
            width: 100%;
        }
        .total-reservas {
            font-size: 0.9rem; /* Reduzido ainda mais no mobile */
            padding: 10px;
        }
        .total-reservas div:last-child {
             font-size: 1rem; /* Aumenta o valor no mobile */
        }
        
        /* 1. Oculta o cabe√ßalho original da tabela */
        #reservasTable thead {
            display: none;
        }

        /* 2. Transforma a linha da tabela (<tr>) em um bloco/card */
        #reservasTable tr {
            display: block;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 10px;
            background-color: var(--bg-card);
        }
        
        /* 3. Transforma a c√©lula da tabela (<td>) em um bloco para empilhamento vertical */
        #reservasTable td {
            display: flex; 
            justify-content: space-between;
            text-align: right;
            border: none; 
            padding: 8px 0; 
            font-size: 0.95rem;
        }
        
        /* 4. Injeta o cabe√ßalho (data-label) usando pseudo-elemento */
        #reservasTable td::before {
            content: attr(data-label);
            font-weight: bold;
            text-transform: uppercase;
            color: #555; 
            padding-right: 10px;
            text-align: left;
            flex-shrink: 0; 
        }
        
        /* NOVO: Ajuste na c√©lula de mesas no mobile (para o destaque) */
        #reservasTable td:nth-child(1) { /* Coluna Mesa(s) */
            background-color: #e3f2fd; 
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            padding: 10px 10px;
        }

        /* NOVO: Ajuste na c√©lula de cadeiras no mobile (para o destaque) */
        #reservasTable td:nth-child(7) { /* Coluna Cadeiras Extras */
            background-color: #fff3e0;
            padding: 10px 10px;
        }
        
        /* NOVO: Ajuste para garantir que o texto destaque no mobile */
        #reservasTable td:nth-child(1) .mesa-highlight,
        #reservasTable td:nth-child(7) .cadeiras-highlight {
            background: none !important; /* Remove o fundo extra no span, usa o fundo do TD */
            color: var(--accent-color);
            font-size: 1.1rem !important;
        }


        /* 5. Telefone: Ajuste a coluna de telefone para alinhar o n√∫mero e o bot√£o PIX */
        #reservasTable td:nth-child(3) {
            flex-direction: column; 
            align-items: flex-start;
            text-align: left;
        }
        #reservasTable td:nth-child(3) .pix-reminder-button {
            margin-left: 0;
            text-align: center;
            width: 100%;
            margin-top: 5px;
        }
        
        /* 6. A√ß√£o: Ajuste a coluna de a√ß√£o (agora 10¬™) para alinhar √† esquerda e ocupar o espa√ßo total */
        #reservasTable td:nth-child(10) { 
            flex-direction: column;
            align-items: flex-start;
            padding-top: 10px;
            padding-bottom: 5px;
            border-top: 1px dashed var(--border-color);
            margin-top: 5px;
            text-align: left; 
        }
        #reservasTable td:nth-child(10)::before {
            display: none; 
        }
        .action-button {
            font-size: 0.8rem;
            padding: 8px 10px;
            width: 100%;
        }
        /* Ajuste na coluna de status para alinhamento */
        #reservasTable td:nth-child(9) { /* Coluna Status, agora 9¬™ */
            text-align: right;
        }


        /* Login screen compacta */
        .login-container {
            padding: 30px 25px;
        }
    }
  </style>
</head>
<body>
  
    <div id="login-screen">
        <div class="login-container">
            <h1>Acesso ao Painel</h1>
            <input type="email" id="email" placeholder="E-mail" required>
            <input type="password" id="password" placeholder="Senha" required>
            <button onclick="login()">Entrar</button>
            <div id="error-message"></div>
        </div>
    </div>
    <div id="dashboard-content">
        <div class="container">
            
            <div id="user-info" class="user-info">
                <span>
                    <img id="profile-img" class="profile-photo" src="" alt="Foto de Perfil">
                    Ol√°, <span id="saudacao-nome">Carregando...</span>
                </span>
                <button class="logout-button" onclick="fazerLogout()">Sair</button>
            </div>
            <h1>Gest√£o de Reservas</h1>
            
            <div class="actions-bar">
                <div class="search-area">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Buscar por Aluno, Turma, Mesa..." onkeyup="filtrarTabela()">
                </div>
                <select id="filtro-turma" onchange="filtrarTabela()" style="margin-left:10px;padding:8px">
                <option value="">Todas as turmas</option>
                </select>

                <button id="filter-extra-chairs-button" class="pdf-button" style="background-color: #e67e22;" onclick="toggleFiltrarCadeirasExtras()">ü™ë Filtrar Cadeiras Extras</button>
                <button class="pdf-button" onclick="exportarPDF()">‚¨áÔ∏è Baixar Relat√≥rio (PDF)</button>
            </div>

            <div class="total-reservas">
                <div style="margin-bottom: 5px;">
                    Total de Mesas no Painel: <span id="totalReservas">0</span> | 
                    <span style="color: var(--confirmed-color);">Mesas PAGAS: </span><span id="totalMesasPagas" style="font-weight: 700; color: var(--confirmed-color);">0</span> |
                    <span style="color: #e67e22;">Cadeiras Extras: </span><span id="totalCadeirasExtras" style="font-weight: 700; color: #e67e22;">0</span>
                    </div>
                <hr style="border: 0; border-top: 1px solid #b2ebf2; margin: 5px 0;">
                <div style="font-size: 1.3rem;">
                    Valor Total GERAL: <span id="valorTotalGeral" style="font-weight: 700;">R$ 0,00</span> | 
                    <span style="color: var(--confirmed-color);">Valor Total ARRECADADO: </span><span id="valorTotalArrecadado" style="font-weight: 700; color: var(--confirmed-color);">R$ 0,00</span>
                </div>
            </div>
            
            <div id="loading" class="loading-text" style="text-align: center;">Carregando dados...</div>
            
            <table id="reservasTable">
                <thead>
                    <tr>
                    <th data-column-index="0" class="sortable">Mesa(s)</th>
                    <th data-column-index="1" class="sortable">Respons√°vel</th>
                    <th data-column-index="2" class="sortable">Telefone</th> 
                    <th data-column-index="3" class="sortable">Aluno / Turma</th>
                    <th data-column-index="4" class="sortable">Valor (R$)</th>
                    <th data-column-index="5" class="sortable">Pagamento</th> 
                    <th data-column-index="6" class="sortable">Cadeiras Extras</th> 
                    <th data-column-index="7" class="sortable sort-desc">Data/Hora</th> 
                    <th>Status</th>
                    <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
                </table>
            </div>
    </div>
    <div id="editModal">
        <div class="modal-content-edit">
            <span class="close-button" onclick="fecharModalEdicao()">&times;</span>
            <h2>Editar Reserva</h2>
            <p>Editando reserva principal da(s) mesa(s): <strong id="editMesas"></strong></p>
            
            <input type="hidden" id="editMesaPrincipalId">

            <label for="editNome">Respons√°vel:</label>
            <input type="text" id="editNome">

            <label for="editTelefone">WhatsApp (Apenas n√∫meros):</label>
            <input type="tel" id="editTelefone" pattern="[0-9]{11}">
            
            <label for="editAluno">Aluno:</label>
            <input type="text" id="editAluno">
            
            <label for="editTurma">Turma:</label>
            <input type="text" id="editTurma">

            <label for="editCadeirasExtras">Cadeiras Extras:</label>
            <input type="number" id="editCadeirasExtras" min="0" value="0"> 
            
            <label for="editFormaPagamento">Forma de Pagamento:</label>
            <select id="editFormaPagamento" onchange="toggleOutrosField()">
                <option value="Pix">Pix</option>
                <option value="Cartao Credito">Cart√£o de Cr√©dito</option>
                <option value="Cartao Debito">Cart√£o de D√©bito</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Outros">Outros...</option>
            </select>
            <input type="text" id="editOutrosDetalhe" placeholder="Especifique o tipo de pagamento" style="display: none; margin-top: -10px;">
            <button class="action-button confirm-button" onclick="salvarEdicao()">Salvar Altera√ß√µes</button>
            <button class="action-button delete-button" onclick="fecharModalEdicao()" style="background-color: #6c757d;">Cancelar</button>
        </div>
    </div>

<script type="module">
    // *** C√ìDIGO JAVASCRIPT UNIFICADO ***

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"; 

    // Sua Configura√ß√£o Exata do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCmuuPAX68dOcESWMFdynI56j_GYkosEmg",
      authDomain: "reservas-tracos-culturais.firebaseapp.com",
      databaseURL: "https://reservas-tracos-culturais-default-rtdb.firebaseio.com",
      projectId: "reservas-tracos-culturais",
      storageBucket: "reservas-tracos-culturais.appspot.com",
      messagingSenderId: "53243907823",
      appId: "1:53243907823:web:1eee06470fe6554f0b551a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app); 
    
    // Elementos DOM
    const dashboardContent = document.getElementById('dashboard-content');
    const loginScreen = document.getElementById('login-screen');
    const errorMessageDiv = document.getElementById('error-message');
    const tbody = document.querySelector('#reservasTable tbody');
    const loadingDiv = document.getElementById('loading');
    
    // SPANS DE CONTADOR DE MESAS
    const totalReservasSpan = document.getElementById('totalReservas');
    const totalMesasPagasSpan = document.getElementById('totalMesasPagas');
    
    // SPANS DE VALOR TOTAL
    const valorTotalGeralSpan = document.getElementById('valorTotalGeral');
    const valorTotalArrecadadoSpan = document.getElementById('valorTotalArrecadado');
    
    // NOVO SPAN E BOT√ÉO PARA CADEIRAS EXTRAS
    const totalCadeirasExtrasSpan = document.getElementById('totalCadeirasExtras');
    const filterButton = document.getElementById('filter-extra-chairs-button');
    // FIM NOVOS ELEMENTOS
    
    const searchInput = document.getElementById('search-input');
    const headers = document.querySelectorAll('#reservasTable th.sortable');
    const formaPagamentoSelect = document.getElementById('editFormaPagamento');
    const outrosDetalheInput = document.getElementById('editOutrosDetalhe');
    const userInfoDiv = document.getElementById('user-info');
    const saudacaoSpan = document.getElementById('saudacao-nome');
    const profileImg = document.getElementById('profile-img');
    
    let dadosAgrupados = [];
    let sortColumn = 7; 
    let sortDirection = 'desc';
    
    // NOVO: VARI√ÅVEL DE ESTADO DO FILTRO
    let isFiltrandoCadeirasExtras = false; 
    
    const FIXED_PAYMENT_OPTIONS = ['Pix', 'Cartao Credito', 'Cartao Debito', 'Dinheiro'];
    
    // Array de labels (usado no mobile view)
    const tableLabels = [
        'MESA(S)', 'RESPONS√ÅVEL', 'TELEFONE', 'ALUNO / TURMA', 
        'VALOR (R$)', 'PAGAMENTO', 'CADEIRAS EXTRAS', 'DATA/HORA', 
        'STATUS', 'A√á√ÉO'
    ];


    // ====================================================
    // 1. L√ìGICA DE AUTENTICA√á√ÉO (CONTROLE DE TELAS)
    // ====================================================
    
    // Mostra a tela de login primeiro
    loginScreen.style.display = 'flex';
    dashboardContent.style.display = 'none';

    // üö®üö®üö® BLOCO DE CONFIGURA√á√ÉO DE NOME E FOTO üö®üö®üö®
    // Mapeamento de E-mail para Nome de Exibi√ß√£o
    const userDisplayNames = {
        "SEU.EMAIL.AQUI@escola.com.br": "SEU NOME COMPLETO AQUI", 
        "financeiro@escola.com.br": "Financeiro",   
        "admin@escola.com.br": "Administrador"       
    };
    
    // Mapeamento de E-mail para URL da Foto (Use URLs p√∫blicas, como do Imgur, Google Drive, ou seu pr√≥prio servidor)
    const userProfilePhotos = {
        "SEU.EMAIL.AQUI@escola.com.br": "URL_DA_SUA_FOTO_AQUI.jpg", 
        "financeiro@escola.com.br": "https://i.imgur.com/FinanceiroDefault.png", 
        "admin@escola.com.br": "https://i.imgur.com/AdminDefault.png"       
    };
    // üö®üö®üö® FIM DO BLOCO DE CONFIGURA√á√ÉO üö®üö®üö®
    
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Usu√°rio logado: Esconde login, mostra dashboard
            loginScreen.style.display = 'none';
            dashboardContent.style.display = 'block'; 
            
            // --- L√≥gica de Personaliza√ß√£o ---
            const email = user.email;
            
            // 1. Nome de Exibi√ß√£o
            let nomeDisplay = userDisplayNames[email] || email.split('@')[0];
            if (nomeDisplay === email.split('@')[0]) {
                 nomeDisplay = nomeDisplay.replace('.', ' ');
                 nomeDisplay = nomeDisplay.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            }
            saudacaoSpan.textContent = nomeDisplay;
            
            // 2. Foto de Perfil
            const fotoUrl = userProfilePhotos[email] || 'https://i.imgur.com/p9vF6qj.png'; // Fallback para √≠cone gen√©rico se n√£o mapeado
            profileImg.src = fotoUrl;
            
            userInfoDiv.style.display = 'flex'; 
            
            // Inicia o carregamento dos dados
            iniciarCarregamentoDeDados(); 
            
        } else {
            // Usu√°rio n√£o logado: Mostra login, esconde dashboard
            dashboardContent.style.display = 'none';
            loginScreen.style.display = 'flex';
            loadingDiv.textContent = 'Carregando dados...';
        }
    });

    // Fun√ß√£o de Login 
    window.login = async function() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        errorMessageDiv.textContent = ''; 

        try {
            await signInWithEmailAndPassword(auth, email, password);
            // O onAuthStateChanged ser√° acionado e mostrar√° o dashboard.
        } catch (error) {
            console.error("Erro de Login:", error);
            
            let message = "‚ùå Erro desconhecido. Tente novamente.";

            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    message = "‚ùå E-mail ou senha incorretos. Verifique suas credenciais.";
                    break;
                case 'auth/invalid-email':
                    message = "‚ùå O formato do e-mail √© inv√°lido.";
                    break;
                default:
                    message = "‚ùå Erro ao tentar conectar. Verifique o console para detalhes.";
            }

            errorMessageDiv.textContent = message;
        }
    }

    // Fun√ß√£o de Logout
    window.fazerLogout = async function() {
        if(confirm("Tem certeza que deseja sair do Painel de Gest√£o?")) {
            try {
                await signOut(auth);
                // O onAuthStateChanged far√° a transi√ß√£o para a tela de login.
            } catch (error) {
                alert("‚ùå Erro ao fazer logout: " + error.message);
                console.error("Erro de Logout:", error);
            }
        }
    }

    // ====================================================
    // 2. FUN√á√ïES DO DASHBOARD
    // ====================================================
    
    function iniciarCarregamentoDeDados() {
        onValue(ref(db, "reservas"), (snapshot) => {
            loadingDiv.style.display = 'none';
            dadosAgrupados = [];

            const reservasData = snapshot.val();
            console.log("Firebase - n√≥s lidos:", snapshot.size || (reservasData ? Object.keys(reservasData).length : 0));
            console.log("Amostra dos dados:", reservasData ? Object.keys(reservasData).slice(0,5).map(k=>({k, v: reservasData[k]})) : reservasData);

            if (!reservasData) {
                renderizarTabela([]);
                return;
            }

            const reservasMap = new Map();

            for (const mesaId in reservasData) {
                const reserva = reservasData[mesaId];
                if (!reserva.status) reserva.status = 'pendente'; 
                
                const formaPagamento = reserva.formaPagamento || 'Pix';
                const telefone = reserva.telefone || 'semtel'; 
                // Garantir que cadeirasExtras seja um n√∫mero
                const cadeirasExtras = parseInt(reserva.cadeirasExtras) || 0; 
                
                // Garantir que valorTotal seja um n√∫mero, com fallback se necess√°rio
                const valorTotal = typeof reserva.valorTotal === 'number' ? reserva.valorTotal : parseFloat(reserva.valorTotal) || 0;

                // ---------- CORRE√á√ÉO: chave simplificada e robusta ----------
                // Antes: inclu√≠a muitos campos que quebravam o agrupamento quando ausentes/variavam.
                // Agora: agrupa por respons√°vel+aluno+data+hor√°rio, que s√£o os campos est√°veis.
                const mesasLista = reserva.mesasSelecionadas ? reserva.mesasSelecionadas.sort().join('|') : 'semmesas';
                const chaveReserva = `${reserva.nome || ''}-${reserva.aluno || ''}-${reserva.data || ''}-${reserva.horario || ''}`;
                // ------------------------------------------------------------

                if (!reservasMap.has(chaveReserva)) {
                    reservasMap.set(chaveReserva, {
                        ...reserva,
                        valorTotal: valorTotal, // Usa o valor normalizado
                        formaPagamento: formaPagamento, 
                        telefone: telefone === 'semtel' ? null : telefone,
                        mesas: [mesaId],
                        cadeirasExtras: cadeirasExtras // Usa o valor num√©rico
                    });
                } else {
                    reservasMap.get(chaveReserva).mesas.push(mesaId);
                }
            }
            
            dadosAgrupados = Array.from(reservasMap.values());
            // ATUALIZA O FILTRO DE TURMAS AP√ìS CARREGAR OS DADOS
            atualizarFiltroTurmas();
            ordenarTabela(sortColumn, sortDirection);

        }, (error) => {
            loadingDiv.textContent = `‚ùå ERRO FATAL ao buscar dados: ${error.message}.`;
            console.error("Firebase Error:", error);
        });
    }

    // FUN√á√ÉO PARA ATUALIZAR O FILTRO DE TURMAS
    function atualizarFiltroTurmas() {
        const select = document.getElementById("filtro-turma");
        const turmas = new Set();

        // Coleta todas as turmas √∫nicas dos dados agrupados
        dadosAgrupados.forEach(reserva => {
            if (reserva.turma) {
                turmas.add(reserva.turma);
            }
        });

        // Limpa e recria as op√ß√µes
        select.innerHTML = "<option value=''>Todas as turmas</option>";
        [...turmas].sort().forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            select.appendChild(opt);
        });
    }

    window.toggleOutrosField = function() {
        if (formaPagamentoSelect.value === 'Outros') {
            outrosDetalheInput.style.display = 'block';
            outrosDetalheInput.focus();
        } else {
            outrosDetalheInput.style.display = 'none';
        }
    }
    
    // FUN√á√ÉO DE FILTRO DE TABELA ATUALIZADA (com filtro de turmas e cadeiras extras)
    window.filtrarTabela = function() {
        const termo = searchInput.value.toLowerCase();
        const filtroTurma = document.getElementById('filtro-turma').value;
        const linhas = tbody.querySelectorAll('tr');

        let mesasVisiveisGeral = 0;
        let mesasVisiveisPagas = 0; 
        let valorVisivelGeral = 0; 
        let valorVisivelArrecadado = 0; 
        let cadeirasVisiveis = 0;

        linhas.forEach(row => {
            const textoLinha = row.textContent.toLowerCase();
            const isVisibleBySearch = textoLinha.includes(termo);
            
            // Encontra a reserva correspondente
            const mesaPrincipalId = row.dataset.mesa;
            const reserva = mesaPrincipalId ? dadosAgrupados.find(r => Array.isArray(r.mesas) ? r.mesas.includes(mesaPrincipalId) : r.mesas[0] === mesaPrincipalId) : null;
            
            const cadeirasExtrasReserva = reserva ? (reserva.cadeirasExtras || 0) : 0;
            
            // Filtro por turma
            const isVisibleByTurma = !filtroTurma || (reserva && reserva.turma === filtroTurma);
            
            // Filtro por cadeiras extras
            const isVisibleByExtraChairsFilter = !isFiltrandoCadeirasExtras || (isFiltrandoCadeirasExtras && cadeirasExtrasReserva > 0);
            
            const isVisible = isVisibleBySearch && isVisibleByTurma && isVisibleByExtraChairsFilter;
            
            row.style.display = isVisible ? '' : 'none';
            
            if(isVisible) {
                if (reserva) {
                    const count = reserva.mesas.length;
                    const valor = reserva.valorTotal || 0; 

                    mesasVisiveisGeral += count;
                    valorVisivelGeral += valor;
                    cadeirasVisiveis += cadeirasExtrasReserva;

                    if (reserva.status === 'paga') {
                        mesasVisiveisPagas += count; 
                        valorVisivelArrecadado += valor;
                    }
                }
            }
        });
        
        // Atualiza os spans de Mesas e Valores
        totalReservasSpan.textContent = mesasVisiveisGeral.toString();
        totalMesasPagasSpan.textContent = mesasVisiveisPagas.toString();
        totalCadeirasExtrasSpan.textContent = cadeirasVisiveis.toString();
        
        valorTotalGeralSpan.textContent = `R$ ${valorVisivelGeral.toFixed(2).replace('.', ',')}`;
        valorTotalArrecadadoSpan.textContent = `R$ ${valorVisivelArrecadado.toFixed(2).replace('.', ',')}`;
    }

    // NOVA FUN√á√ÉO: Alternar o filtro de cadeiras extras
    window.toggleFiltrarCadeirasExtras = function() {
        isFiltrandoCadeirasExtras = !isFiltrandoCadeirasExtras; 
        
        if (isFiltrandoCadeirasExtras) {
            filterButton.style.backgroundColor = '#2ecc71'; // Verde para indicar ativo
            filterButton.textContent = '‚úÖ Cadeiras Extras (Ativo)';
        } else {
            filterButton.style.backgroundColor = '#e67e22'; // Laranja original
            filterButton.textContent = 'ü™ë Filtrar Cadeiras Extras';
        }
        
        // Aplica o filtro imediatamente
        filtrarTabela(); 
    }

    function ordenarTabela(index, direction) {
        // Remove classes dos cabe√ßalhos sort√°veis
        document.querySelectorAll('#reservasTable th.sortable').forEach(h => {
            h.classList.remove('sort-asc', 'sort-desc');
        });

        // Marca corretamente o cabe√ßalho por data-column-index
        const headerToMark = document.querySelector(`#reservasTable th[data-column-index="${index}"]`);
        if (headerToMark) {
            headerToMark.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }

        dadosAgrupados.sort((a, b) => {
            let aVal, bVal;
            
            switch (index) {
                case 0: aVal = parseInt(a.mesas[0]); bVal = parseInt(b.mesas[0]); break; 
                case 1: aVal = a.nome || ''; bVal = b.nome || ''; break; 
                case 2: aVal = a.telefone || ''; bVal = b.telefone || ''; break; 
                case 3: aVal = a.aluno || ''; bVal = b.aluno || ''; break; 
                case 4: aVal = Number(a.valorTotal || 0); bVal = Number(b.valorTotal || 0); break; // Ordena por Valor
                case 5: aVal = a.formaPagamento || 'Pix'; bVal = b.formaPagamento || 'Pix'; break; 
                case 6: aVal = parseInt(a.cadeirasExtras || 0); bVal = parseInt(b.cadeirasExtras || 0); break; 
                case 7: 
                default:
                    // Ordena√ß√£o por Data/Hora 
                    // Prote√ß√£o para formatos ausentes
                    const aDataStr = `${(a.data||'').split('/').reverse().join('-') || ''}T${a.horario || '00:00'}:00`;
                    const bDataStr = `${(b.data||'').split('/').reverse().join('-') || ''}T${b.horario || '00:00'}:00`;
                    const aDate = new Date(aDataStr);
                    const bDate = new Date(bDataStr);
                    if (!isNaN(aDate) && !isNaN(bDate)) {
                        return direction === 'asc' ? aDate - bDate : bDate - aDate;
                    } else {
                        // fallback para strings se data inv√°lida
                        aVal = (a.data || '') + ' ' + (a.horario || '');
                        bVal = (b.data || '') + ' ' + (b.horario || '');
                    }
            }

            // Se aVal/bVal estiverem definidas acima como valor simples:
            if (typeof aVal === 'number' && typeof bVal === 'number') {
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            } else {
                aVal = aVal || '';
                bVal = bVal || '';
                return direction === 'asc' ? aVal.toString().localeCompare(bVal.toString()) : bVal.toString().localeCompare(aVal.toString());
            }
        });

        renderizarTabela(dadosAgrupados);
    }
    
    // Fun√ß√£o para gerar a mensagem de Lembrete PIX 
    function getMensagemLembretePix(reserva) {
        const PIX_CHAVE = "45.701.401/0001-07";
        const mesasTexto = reserva.mesas.sort((a, b) => parseInt(a) - parseInt(b)).join(', ');
        const valorTexto = `R$ ${reserva.valorTotal.toFixed(2).replace('.', ',')}`;

        const mensagem = `
*LEMBRETE DE RESERVA - FESTA DA FAM√çLIA*

Ol√°, ${reserva.nome}!

Identificamos a sua reserva das *Mesas ${mesasTexto}* no valor de *${valorTexto}* para o nosso evento.

O prazo para a confirma√ß√£o via PIX √© de *24 horas*. Se voc√™ ainda n√£o pagou, segue a chave PIX novamente:

*CHAVE PIX CNPJ:* ${PIX_CHAVE}
*Nome:* Col√©gio Antoni Gaudi

*Lembrete:* Sua reserva ser√° EXCLUIDA se o pagamento n√£o for confirmado a tempo.
*Por favor, assim que o pagamento for efetuado, envie-nos o comprovante.*
Agradecemos e aguardamos a sua confirma√ß√£o!
        `.trim();
        return mensagem;
    }

    // FUN√á√ÉO renderizarTabela MODIFICADA PARA SOMAR VALORES E CADEIRAS EXTRAS
    function renderizarTabela(reservas) {
        tbody.innerHTML = '';
        let totalMesasGeral = 0; 
        let totalMesasPagas = 0; 
        let valorTotalGeral = 0; 
        let valorTotalArrecadado = 0; 
        let totalCadeirasExtras = 0; // NOVO: Acumulador de Cadeiras Extras
        
        const labels = tableLabels; 

        reservas.forEach(reserva => {
            const row = tbody.insertRow();
            
            const numMesas = reserva.mesas.length;
            const valorReserva = reserva.valorTotal || 0; 
            const cadeirasExtrasReserva = reserva.cadeirasExtras || 0;

            totalMesasGeral += numMesas;
            valorTotalGeral += valorReserva;
            totalCadeirasExtras += cadeirasExtrasReserva; // Acumula o total de cadeiras

            const status = reserva.status || 'pendente';
            
            if (status === 'paga') {
                totalMesasPagas += numMesas; 
                valorTotalArrecadado += valorReserva; 
            }

            // 0. Mesa(s) (COM DESTAQUE)
            const mesasCell = row.insertCell();
            const mesasTexto = reserva.mesas.sort((a, b) => parseInt(a) - parseInt(b)).join(', ');
            mesasCell.innerHTML = `<span class="mesa-highlight">${mesasTexto}</span>`; 
            mesasCell.setAttribute('data-label', labels[0]);

            // 1. Respons√°vel
            const responsavelCell = row.insertCell();
            responsavelCell.textContent = reserva.nome; 
            responsavelCell.setAttribute('data-label', labels[1]);

            // 2. Telefone
            const telCell = row.insertCell(); 
            telCell.setAttribute('data-label', labels[2]);
            const telefoneFormatado = reserva.telefone ? reserva.telefone.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3') : 'N/A';
            
            telCell.innerHTML = `
              ${telefoneFormatado} 
              ${reserva.telefone ? `<a href="https://wa.me/55${reserva.telefone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(getMensagemLembretePix(reserva))}" target="_blank" class="pix-reminder-button">
                Lembrete PIX
              </a>` : ''}
            `;
            
            // 3. Aluno / Turma
            const alunoTurmaCell = row.insertCell();
            alunoTurmaCell.textContent = `${reserva.aluno} (${reserva.turma})`; 
            alunoTurmaCell.setAttribute('data-label', labels[3]);

            // 4. Valor (R$)
            const valorCell = row.insertCell();
            valorCell.textContent = `R$ ${valorReserva.toFixed(2).replace('.', ',')}`; 
            valorCell.setAttribute('data-label', labels[4]);

            // 5. Pagamento
            const pagamentoCell = row.insertCell();
            const formaPagamento = reserva.formaPagamento || 'Pix';
            pagamentoCell.textContent = formaPagamento; 
            pagamentoCell.setAttribute('data-label', labels[5]);

            // 6. Cadeiras Extras (COM DESTAQUE)
            const cadeirasCell = row.insertCell();
            const cadeirasTexto = cadeirasExtrasReserva.toString();
            cadeirasCell.innerHTML = `<span class="cadeiras-highlight">${cadeirasTexto}</span>`; 
            cadeirasCell.setAttribute('data-label', labels[6]);
            
            // 7. Data/Hora (√çndice ajustado)
            const dataHoraCell = row.insertCell();
            dataHoraCell.textContent = `${reserva.data} ${reserva.horario}`; 
            dataHoraCell.setAttribute('data-label', labels[7]);
            
            // 8. Status (√çndice ajustado)
            const statusCell = row.insertCell();
            statusCell.setAttribute('data-label', labels[8]);
            
            let statusClass = 'status-pendente'; 
            let statusText = 'PENDENTE (PIX)';   

            if (status === 'paga') {
                statusClass = 'status-confirmado';
                statusText = 'PAGA (CONFIRMADO)';
            } else if (status === 'cancelamento-solicitado') {
                statusClass = 'status-cancelamento';
                statusText = 'CANCELAMENTO SOLICITADO';
            }

            statusCell.innerHTML = `<span class="status-badge ${statusClass}">${statusText}</span>`;

            // 9. A√ß√£o (√çndice ajustado)
            const actionCell = row.insertCell();
            actionCell.setAttribute('data-label', labels[9]); 
            const mesaPrincipal = reserva.mesas[0];
            
            // ---------- CORRE√á√ÉO: armazenar mesaPrincipal no dataset para busca/filtragem ----------
            row.dataset.mesa = mesaPrincipal;
            // ------------------------------------------------------------------------------------
            
            let actionHTML = '';
            
            actionHTML += `<button class="action-button delete-button" onclick="cancelarReserva('${mesaPrincipal}')">‚ùå Cancelar / Estornar</button>`;
            actionHTML += `<button class="action-button edit-button" onclick="abrirModalEdicao('${mesaPrincipal}')">‚úèÔ∏è Editar</button>`;

            if (status === 'pendente' || status === 'cancelamento-solicitado') { 
                actionHTML += `<button class="action-button confirm-button" onclick="confirmarPagamento('${mesaPrincipal}')">‚úÖ Confirmar</button>`;
            } 
            
            if (status === 'paga') {
                actionHTML += `<button class="action-button" style="background-color: #8e44ad; margin-top: 5px;" onclick="enviarConfirmacaoFinal('${mesaPrincipal}')">‚úâÔ∏è Confirma√ß√£o Final</button>`; 
            }
            
            actionCell.innerHTML = actionHTML;
        });
        
        // ATUALIZA√á√ÉO DOS SPANS DE CONTADORES E VALORES GERAIS
        totalReservasSpan.textContent = totalMesasGeral.toString();
        totalMesasPagasSpan.textContent = totalMesasPagas.toString();
        totalCadeirasExtrasSpan.textContent = totalCadeirasExtras.toString(); // NOVO: Atualiza o total de cadeiras extras
        
        valorTotalGeralSpan.textContent = `R$ ${valorTotalGeral.toFixed(2).replace('.', ',')}`;
        valorTotalArrecadadoSpan.textContent = `R$ ${valorTotalArrecadado.toFixed(2).replace('.', ',')}`;
        
        // Filtra para garantir que apenas os resultados do filtro/busca (se houver) sejam mostrados
        filtrarTabela(); 
    }

    // ====================================================
    // 3. FUN√á√ïES DE A√á√ÉO (CONFIRMAR, EDITAR, CANCELAR)
    // ====================================================

    window.confirmarPagamento = async function(mesaPrincipalId) {
        const confirmacao = confirm(`Tem certeza que deseja CONFIRMAR o pagamento para a reserva da MESA ${mesaPrincipalId}?`);
        
        if (confirmacao) {
            try {
                const reservaParaConfirmar = dadosAgrupados.find(r => r.mesas[0] === mesaPrincipalId);
                
                if (!reservaParaConfirmar) {
                    alert('‚ùå Erro: Reserva n√£o encontrada localmente.');
                    return;
                }

                const mesasIds = reservaParaConfirmar.mesas;
                const updates = {};
                
                mesasIds.forEach(mesaId => {
                    updates[`/reservas/${mesaId}/status`] = 'paga';
                });

                await update(ref(db), updates); 
                
                alert(`‚úÖ Pagamento CONFIRMADO para as mesas: ${mesasIds.join(', ')}.`);

            } catch (error) {
                alert(`‚ùå Erro ao confirmar pagamento: ${error.message}`);
                console.error("Erro no Firebase:", error);
            }
        }
    }


    // FUN√á√ÉO: CANCELAR E ESTORNAR 
    window.cancelarReserva = async function(mesaPrincipalId) {
        // 1. Encontra a reserva para coletar os dados
        const reservaParaCancelar = dadosAgrupados.find(r => r.mesas[0] === mesaPrincipalId);
        
        if (!reservaParaCancelar) {
            alert('‚ùå Erro: Reserva n√£o encontrada localmente.');
            return;
        }
        
        const mesasIds = reservaParaCancelar.mesas;
        const mesasTexto = mesasIds.join(', ');

        // 2. Confirma√ß√£o
        const confirmacao = confirm(
            `Tem certeza que deseja CANCELAR a reserva das mesas ${mesasTexto}? \n\n` +
            `‚ö†Ô∏è Esta a√ß√£o ir√° DELETAR a reserva do sistema e DEVE ser usada para processar o ESTORNO/DEVOLU√á√ÉO do valor.`
        );
        
        if (confirmacao) {
            try {
                const updates = {};
                
                // Marca as mesas para exclus√£o (define como 'null')
                mesasIds.forEach(mesaId => {
                    updates[`/reservas/${mesaId}`] = null;
                });

                // Executa a exclus√£o at√¥mica no Firebase
                await update(ref(db), updates); 
                
                alert(`‚ùå Reservas das mesas ${mesasTexto} CANCELADAS e liberadas com sucesso! Fazer ESTORNO.`);

                // 3. Notifica√ß√£o (A√ß√£o para o ADM)
                enviarNotificacaoCancelamento(reservaParaCancelar);

            } catch (error) {
                alert(`‚ùå Erro ao cancelar reserva: ${error.message}`);
                console.error("Erro no Firebase:", error);
            }
        }
    }

    // Fun√ß√£o para enviar o WhatsApp de Estorno (mantida da vers√£o anterior)
    function enviarNotificacaoCancelamento(reserva) {
        const mesas = reserva.mesas.join(', ');
        const valor = reserva.valorTotal.toFixed(2).replace('.', ',');
        const status = reserva.status === 'paga' ? 'PAGA' : 'PENDENTE'; 
        const telefone = reserva.telefone || 'N/A';

        const mensagem = `
*CANCELAMENTO DE RESERVA/ESTORNO* üö´
---
*A√á√ÉO NECESS√ÅRIA: ESTORNO!*
---
*Respons√°vel:* ${reserva.nome}
*Telefone:* ${telefone}
*Aluno/Turma:* ${reserva.aluno} (${reserva.turma})
*Mesas:* ${mesas}
*Valor a Estornar:* R$ ${valor}
*Status Original:* ${status}

*ATEN√á√ÉO:* Esta reserva foi deletada do sistema e o estorno deve ser processado.
        `.trim().replace(/\n/g, '%0A');

        const numeroFinanceiro = '5571999183320'; 

        window.open(`https://wa.me/${numeroFinanceiro}?text=${mensagem}`, '_blank');
    }
    
    // FUN√á√ÉO: Enviar Confirma√ß√£o Final ao Cliente
    window.enviarConfirmacaoFinal = function(mesaPrincipalId) {
        const reserva = dadosAgrupados.find(r => r.mesas[0] === mesaPrincipalId);
        
        if (!reserva || reserva.status !== 'paga') { 
            alert("‚ùå Erro: Apenas reservas PAGAS (Status 'Paga') podem receber o envio final.");
            return;
        }
        
        // VALORES FIXOS (Ajuste se necess√°rio)
        const localEvento = "QUADRA IF BAIANO - CAMPUS CATU";
        const dataEvento = "06 de Dezembro, 19:00h";
        
        const mesasTexto = reserva.mesas.join(', ');
        const cadeirasTexto = reserva.cadeirasExtras > 0 ? ` + ${reserva.cadeirasExtras} Cadeira(s) Extra(s)` : '';

        const mensagemFinal = `
*PRESEN√áA CONFIRMADA!* *FESTA DA FAM√çLIA*

Ol√°, ${reserva.nome}!

Obrigado por confirmar sua reserva. Sua presen√ßa e a de seus convidados est√£o garantidas!

*Detalhes da Sua Reserva:*
*Respons√°vel:* ${reserva.nome}
*Aluno:* ${reserva.aluno} (${reserva.turma})
*Mesa(s) Reservada(s):* ${mesasTexto}${cadeirasTexto}
*Status:* PAGAMENTO CONFIRMADO

*Detalhes do Evento:*
*Local:* ${localEvento}
*Data/Hora:* ${dataEvento}

Esperamos por voc√™s! Pedimos a gentileza de chegar com 15 minutos de anteced√™ncia.
        `.trim().replace(/\n/g, '%0A');

        let telefoneDestino = reserva.telefone;

        if (!telefoneDestino) {
            // Se o telefone n√£o estiver nos dados, pede ao administrador
            const inputTel = prompt("O telefone n√£o foi encontrado. Por favor, digite o n√∫mero do WhatsApp do respons√°vel (apenas n√∫meros, com DDD):");
            if (inputTel && inputTel.match(/^[0-9]+$/)) {
                 telefoneDestino = inputTel.replace(/[^0-9]/g, '');
            } else {
                alert("‚ùå N√∫mero de telefone inv√°lido ou cancelado.");
                return;
            }
        }
        
        // Envia APENAS a mensagem de texto
        window.open(`https://wa.me/55${telefoneDestino}?text=${mensagemFinal}`, '_blank');
    };
    // FUN√á√ïES DO MODAL DE EDI√á√ÉO 
    window.abrirModalEdicao = function(mesaPrincipalId) {
        const reserva = dadosAgrupados.find(r => r.mesas[0] === mesaPrincipalId);
        
        if (!reserva) {
            alert('‚ùå Reserva n√£o encontrada para edi√ß√£o.');
            return;
        }

        document.getElementById('editMesaPrincipalId').value = mesaPrincipalId;
        document.getElementById('editMesas').textContent = reserva.mesas.sort((a, b) => parseInt(a) - parseInt(b)).join(', ');
        
        document.getElementById('editNome').value = reserva.nome || '';
        document.getElementById('editTelefone').value = reserva.telefone || '';
        document.getElementById('editAluno').value = reserva.aluno || '';
        document.getElementById('editTurma').value = reserva.turma || '';
        document.getElementById('editCadeirasExtras').value = reserva.cadeirasExtras || 0; 
        
        let formaPagamentoSalva = reserva.formaPagamento || 'Pix';
        
        // Trata n√∫meros como string para o select
        if (typeof formaPagamentoSalva !== 'string') {
            formaPagamentoSalva = formaPagamentoSalva.toString();
        }

        if (FIXED_PAYMENT_OPTIONS.includes(formaPagamentoSalva)) {
            formaPagamentoSelect.value = formaPagamentoSalva;
            outrosDetalheInput.value = '';
        } else {
            formaPagamentoSelect.value = 'Outros';
            outrosDetalheInput.value = formaPagamentoSalva;
        }
        
        toggleOutrosField(); 
        document.getElementById('editModal').style.display = 'flex';
    }

    window.fecharModalEdicao = function() {
        document.getElementById('editModal').style.display = 'none';
    }

    window.salvarEdicao = async function() {
        const mesaPrincipalId = document.getElementById('editMesaPrincipalId').value;
        const novoNome = document.getElementById('editNome').value;
        const novoTelefone = document.getElementById('editTelefone').value.replace(/[^0-9]/g, ''); 
        const novoAluno = document.getElementById('editAluno').value;
        const novaTurma = document.getElementById('editTurma').value;
        const novasCadeirasExtras = parseInt(document.getElementById('editCadeirasExtras').value) || 0; 
        
        let novaFormaPagamento = formaPagamentoSelect.value;
        
        if (novaFormaPagamento === 'Outros') {
            novaFormaPagamento = outrosDetalheInput.value || 'Outros (n√£o especificado)';
        }

        const reservaOriginal = dadosAgrupados.find(r => r.mesas[0] === mesaPrincipalId);
        if (!reservaOriginal) return alert('‚ùå Erro interno: Reserva n√£o encontrada.');

        const mesasIds = reservaOriginal.mesas;
        const updates = {};
        
        mesasIds.forEach(mesaId => {
            updates[`/reservas/${mesaId}/nome`] = novoNome;
            updates[`/reservas/${mesaId}/telefone`] = novoTelefone;
            updates[`/reservas/${mesaId}/aluno`] = novoAluno;
            updates[`/reservas/${mesaId}/turma`] = novaTurma;
            updates[`/reservas/${mesaId}/formaPagamento`] = novaFormaPagamento;
            updates[`/reservas/${mesaId}/cadeirasExtras`] = novasCadeirasExtras; 
        });

        try {
            await update(ref(db), updates);
            alert(`‚úÖ Reserva das mesas ${mesasIds.join(', ')} editada com sucesso!`);
            fecharModalEdicao();
        } catch (error) {
            alert(`‚ùå Erro ao salvar edi√ß√£o: ${error.message}`);
            console.error("Erro no Firebase:", error);
        }
    }
    
    // ====================================================
    // 4. FUN√á√ÉO DE EXPORTA√á√ÉO (PDF)
    // ====================================================

    window.exportarPDF = function() {
        const { jsPDF } = window.jspdf;
        // @ts-ignore
        const doc = new jsPDF('landscape');

        const tabela = document.getElementById('reservasTable');
        // Captura apenas as linhas vis√≠veis (aplicando o filtro atual)
        const linhasVisiveis = Array.from(tabela.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
        
        if (linhasVisiveis.length === 0) {
            alert("N√£o h√° dados vis√≠veis para exportar.");
            return;
        }
        
        // Colunas a serem exportadas: Mesa, Respons√°vel, Telefone, Aluno/Turma, Valor, Pagamento, Cadeiras Extras, Data/Hora, Status
        const cabecalhos = Array.from(tabela.querySelectorAll('thead th')).map(th => th.textContent.trim()).slice(0, 9); // Pega 9 colunas

        const dados = linhasVisiveis.map(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            return cells.slice(0, 9).map((cell, index) => { // Pega 9 c√©lulas
                // A coluna Telefone (index 2) precisa do texto sem o link do WhatsApp
                if (index === 2) { 
                    const text = cell.firstChild ? cell.firstChild.textContent.trim() : cell.textContent.trim();
                    return text.replace('N/A', '').trim();
                }
                return cell.textContent.trim();
            }); 
        });

        doc.setFontSize(16);
        doc.setTextColor(50, 50, 50); 
        doc.text("Relat√≥rio de Reservas - Festa da Fam√≠lia", 140, 15, { align: "center" });
        doc.setFontSize(10);
        
        let tituloRelatorio = `Reservas no Relat√≥rio: ${linhasVisiveis.length} transa√ß√µes`;
        if (isFiltrandoCadeirasExtras) {
            const totalCadeirasNoRelatorio = totalCadeirasExtrasSpan.textContent;
            tituloRelatorio = `RELAT√ìRIO: Reservas com CADEIRAS EXTRAS (${totalCadeirasNoRelatorio} cadeiras)`;
        }
        
        doc.text(tituloRelatorio, 140, 22, { align: "center" });
        
        // Adiciona o total de valor no PDF
        const valorGeral = valorTotalGeralSpan.textContent;
        const valorArrecadado = valorTotalArrecadadoSpan.textContent;
        doc.text(`Total Geral VIS√çVEL: ${valorGeral} | Total Arrecadado VIS√çVEL (PAGO): ${valorArrecadado}`, 140, 26, { align: "center" });


        doc.autoTable({
            startY: 32, // Ajustado para dar espa√ßo para o novo texto
            head: [cabecalhos],
            body: dados,
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: [0, 123, 255], textColor: 255 } 
        });
        
        let nomeArquivo = `Reservas_Tracos_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}`;
        if (isFiltrandoCadeirasExtras) {
            nomeArquivo = `Cadeiras_Extras_Relatorio_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}`;
        }

        doc.save(`${nomeArquivo}.pdf`);
    }

  </script>
</body>
</html>
