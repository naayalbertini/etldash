<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Festa da Fam√≠lia - Reserva de Mesas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
    
    /* Reset and Modern Base */
    * { 
        box-sizing: border-box; 
        transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease, color 0.3s ease;
    }
    
    /* LUXURY DESIGN BASE */
    body {
        font-family: 'Inter', sans-serif;
        background: radial-gradient(circle at center, #0d1a26 0%, #000000 100%);
        color: #f0f0f0; 
        margin: 0;
        padding: 20px 10px; 
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    /* HEADER REFINADO - CORRE√á√ÉO DE ALINHAMENTO */
    .header-content {
        display: flex;
        align-items: center;
        justify-content: center; 
        gap: 20px; 
        margin-bottom: 2rem;
        flex-wrap: wrap;
        max-width: 900px;
        width: 100%;
        text-align: center; 
    }
    .header-content img {
        height: 80px; 
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1));
    }
    
    /* CAIXA DOURADA DO T√çTULO (PLACA) */
    .title-box {
        text-align: center;
        padding: 15px 30px;
        border: 1px solid #d4af37; 
        border-radius: 15px;
        background: rgba(212, 175, 55, 0.05); 
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); 
        min-width: 250px; 
        flex-grow: 1; 
    }

    .title-box h1 {
        font-weight: 700; 
        font-size: 3.0rem; 
        margin: 0 0 5px 0; 
        line-height: 1.1;
        color: #d4af37; 
        text-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
    }

    .title-box .subtitle {
        display: block;
        font-size: 1.1rem; 
        font-weight: 300;
        color: #ccc; 
        margin-top: 5px;
    }
    
    /* Grid das Mesas (Responsivo: 4-Corredor-3) */
    .grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr); 
        gap: 10px; 
        max-width: 700px; 
        width: 100%;
        margin: 30px auto;
    }
    
    /* MESA STYLES */
    .mesa {
        aspect-ratio: 1/1;
        background: #28a745; 
        color: #fff;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px; 
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        font-size: 1rem;
        border: 1px solid rgba(255,255,255,0.1); 
        text-shadow: 0 0 2px rgba(0,0,0,0.5); 
        text-align: center;
        line-height: 1.2;
    }
    .mesa:hover {
        transform: translateY(-3px) scale(1.03); 
        box-shadow: 0 8px 20px rgba(0,0,0,0.6), 0 0 15px rgba(255,255,255,0.1);
    }
    
    .mesa.reservada { 
        background: #dc3545; 
        color: #fff; 
        cursor: not-allowed;
        border-color: #f00;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    
    .mesa.cancelamento-solicitado {
        background: #6c757d; 
        cursor: not-allowed;
        border-color: #999;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    .mesa.selecionada {
        background: #007bff; 
        box-shadow: 0 0 0 4px #007bff, 0 8px 20px rgba(0,0,0,0.6); 
        border-color: #007bff;
    }
    
    .espaco {
        background: rgba(255,255,255,0.05); 
        pointer-events: none;
        border: none;
        box-shadow: none;
        border-radius: 8px; 
    }

    /* Legendas de Status */
    .status-legend {
        display: flex;
        justify-content: center;
        gap: 18px;
        margin-bottom: 25px;
        flex-wrap: wrap;
        max-width: 650px;
        width: 100%;
        padding: 0 10px;
    }
    .status-legend div {
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: bold;
        font-size: 0.9rem;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .status-legend div span {
            text-transform: uppercase;
    }

    /* FORMUL√ÅRIO - DESIGN SOFISTICADO */
    form {
        background: #1a1a1a; 
        padding: 35px 40px; 
        border-radius: 20px; 
        margin-top: 40px;
        max-width: 500px; 
        width: 100%;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.9);
        border: 1px solid #333;
        animation: fadeIn 0.8s ease-out; 
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    label {
        display: block;
        margin-top: 20px;
        margin-bottom: 8px;
        font-size: 1rem;
        font-weight: 500;
        color: #ccc; 
    }
    input, select {
        display: block;
        width: 100%;
        margin-bottom: 15px;
        font-size: 1rem;
        background: #2a2a2a; 
        color: #eee;
        border: 1px solid #4a4a4a;
        padding: 14px; 
        border-radius: 10px;
        appearance: none; 
        -webkit-appearance: none;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
    }
    input:focus, select:focus {
            outline: none;
            border-color: #d4af37; 
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.5), inset 0 1px 3px rgba(0,0,0,0.3);
            background: #222222;
    }
    
    #total {
        text-align: center;
        font-weight: bold;
        font-size: 1.5rem; 
        margin-top: 30px;
        padding: 15px;
        border-top: 1px solid #333;
        color: #d4af37; 
        text-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
    }
    form button {
        margin-top: 25px;
        width: 100%;
        background: linear-gradient(145deg, #d4af37, #a38127); 
        color: #000; 
        padding: 16px;
        border: none;
        border-radius: 10px;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        letter-spacing: 0.5px;
    }
    form button:hover {
        background: linear-gradient(145deg, #a38127, #d4af37); 
        box-shadow: 0 8px 20px rgba(0,0,0,0.7), 0 0 20px rgba(212, 175, 55, 0.5);
        transform: translateY(-2px);
    }
    
    /* Aviso Style */
    .aviso {
            border-left: 4px solid #d4af37; 
            background-color: #222222; 
            color: #e0e0e0;
            padding: 18px;
            border-radius: 10px;
            margin-top: 25px;
            font-size: 0.95rem;
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    /* Modal PIX */
    .modal-content {
            background-color: #1a1a1a;
            border: 1px solid #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
            color: #f0f0f0;
            padding: 30px; 
            width: 90%; 
            max-width: 450px; 
            border-radius: 15px; 
    }
    .modal-content h2 {
            color: #d4af37;
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
            font-size: 2rem;
            margin-bottom: 20px;
    }
    .modal-content strong {
            color: #d4af37;
    }
    .modal-content button {
            background: linear-gradient(145deg, #25d366, #1da851) !important;
            color: #fff !important;
            padding: 15px 30px !important;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            margin-top: 30px !important; 
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            font-size: 1.1rem !important;
            width: 100% !important; 
    }
    .modal-content button:hover {
            background: #1da851 !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
            transform: translateY(-1px);
    }
    #btnCopiarPix {
            background: #007bff !important; 
            color: white !important; 
            padding: 10px 15px !important; 
            border-radius: 10px !important;
            font-size: 0.9rem !important;
            width: auto !important;
            flex-shrink: 0 !important;
            margin: 0 !important;
            cursor: pointer !important;
            border: none !important;
    }
    #btnCopiarPix:hover {
            background: #0069d9 !important;
    }
    #chavePixInput {
            flex-grow: 1; 
            margin-bottom: 0; 
            text-align: center; 
            font-weight: bold; 
            font-size: 1.1rem; 
            padding: 10px; 
            border-radius: 10px; 
            background: #2a2a2a; 
            border: 1px solid #4a4a4a; 
            color: #eee;
    }
    .pix-input-container {
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            align-items: center;
    }


    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.75);
        justify-content: center;
        align-items: center;
    }
    .close-button {
        position: absolute; 
        top: 10px; 
        right: 20px;
        font-size: 28px;
        font-weight: 300;
        cursor: pointer;
        color: #d4af37; 
    }

    /* Style for the BIG WARNING (Duplicate Reservation) */
    .duplicate-warning {
        background-color: #ffd700; /* Fundo Amarelo/Dourado para chamar a aten√ß√£o */
        color: #333; /* Texto escuro */
        padding: 25px;
        border-radius: 15px;
        margin: 30px auto;
        max-width: 500px;
        width: 100%;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        border: 3px solid #dc3545; /* Borda Vermelha para urg√™ncia */
    }
    .duplicate-warning h3 {
        color: #dc3545; /* Vermelho forte */
        font-size: 1.8rem;
        margin-top: 0;
        margin-bottom: 10px;
    }
    .duplicate-warning p {
        font-size: 1.1rem;
        line-height: 1.4;
    }
    
    /* NOVO: Estilo para o bot√£o de Prosseguir do Aviso */
    .duplicate-warning .proceed-button {
        background: #007bff; /* Azul para contraste e destaque */
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        display: block;
        width: 100%;
        font-size: 1rem;
    }
    .duplicate-warning .proceed-button:hover {
        background: #0056b3;
        transform: translateY(-1px);
    }


    /* RESPONSIVIDADE FINAL */
    @media (max-width: 768px) {
            .title-box { padding: 10px 20px; border-radius: 10px; }
            .title-box h1 { font-size: 2.2rem; } 
            .title-box .subtitle { font-size: 1rem; }
            .header-content img { height: 60px; }
            .header-content { gap: 15px; } 
            
            .grid { 
                max-width: 100%; 
                gap: 6px; 
            }
            
            .mesa { font-size: 0.8rem; border-radius: 8px; }
            form { padding: 25px; margin-top: 30px; border-radius: 15px; }
            label { font-size: 0.9rem; margin-top: 15px; }
            input, select { padding: 10px; border-radius: 8px; font-size: 0.95rem; }
            #total { font-size: 1.2rem; padding: 12px; }
            form button { padding: 14px; font-size: 1rem; border-radius: 8px; }
            .aviso { padding: 15px; border-radius: 8px; font-size: 0.85rem; margin-top: 20px; }
            .status-legend { gap: 10px; }
            .status-legend div { padding: 5px 8px; font-size: 0.75rem; border-radius: 4px; }
            .modal-content button { font-size: 1rem !important; padding: 12px 25px !important; }
            #chavePixInput { font-size: 1rem; padding: 8px; }
            #btnCopiarPix { font-size: 0.8rem !important; padding: 8px 12px !important; }
    }

    @media (max-width: 480px) { 
            body { padding: 10px; } 
            
            .header-content { 
                gap: 10px; 
                flex-direction: row; 
                align-items: center;
                justify-content: space-around;
            }
            .header-content img { height: 45px; }
            .title-box { 
                padding: 10px 15px; 
                min-width: unset; 
                flex-grow: 1;
                margin: 0;
            }
            .title-box h1 { font-size: 1.8rem; } 
            .title-box .subtitle { font-size: 0.8rem; }
            
            .grid { gap: 5px; } 
            .mesa { font-size: 0.7rem; border-radius: 5px; } 

            form { padding: 20px; margin-top: 25px; border-radius: 12px; }
            label { font-size: 0.85rem; margin-top: 12px; }
            input, select { padding: 8px; border-radius: 6px; font-size: 0.9rem; }
            #total { font-size: 1.1rem; padding: 10px; }
            form button { padding: 12px; font-size: 0.95rem; border-radius: 6px; }
            .aviso { padding: 12px; border-radius: 6px; font-size: 0.8rem; margin-top: 15px; }
            .status-legend div { font-size: 0.65rem; padding: 4px 6px; }
            
            .modal-content {
                padding: 20px; 
            }
            .modal-content h2 {
                font-size: 1.5rem;
            }
            .modal-content button {
                padding: 10px !important;
                font-size: 0.9rem !important;
            }
            .duplicate-warning {
                padding: 15px;
            }
            .duplicate-warning h3 {
                font-size: 1.4rem;
            }
            .duplicate-warning p {
                font-size: 1rem;
            }
    }
    </style>
</head>
<body>
    <div class="header-content">
        <img src="img/tracos.png" alt="Escola Tra√ßos e Letras">
        <div class="title-box">
            <h1>Festa da Fam√≠lia</h1>
            <span class="subtitle">Reserva de Mesas</span>
        </div>

<div class="status-legend">
    <div style="background-color: #28a745; color: white;">
        üü© <span>DISPON√çVEL</span>
    </div>
    <div style="background-color: #dc3545; color: white;">
        üü• <span>RESERVADA</span>
    </div>
</div>

<div class="aviso" style="max-width: 650px; width: 100%; margin: 15px auto;">
    <strong>Aten√ß√£o:</strong> Caso voc√™ desista da compra ou repasse a mesa para outra pessoa, por favor, pe√ßo que informe com urg√™ncia a secretaria escolar. Isso ajuda na organiza√ß√£o do evento!
</div>

<div class="grid" id="mesas"></div>

<div id="duplicateWarning" class="duplicate-warning" style="display: none;">
    </div>
<div id="pixModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="fecharModal()">&times;</span>
            <h2>Solicita√ß√£o de Reserva Registrada!</h2>
            <p style="font-weight: bold; color: #d4af37;">Sua reserva est√° *PENDENTE* e ser√° liberada se o pagamento n√£o for confirmado a tempo.</p>
            
            <p style="margin-top: 20px;"><strong>Valor Total:</strong> <span id="pixValor"></span></p>
            
            <label for="chavePixInput" style="margin-top: 15px; margin-bottom: 5px; color: #ccc;">Chave Pix (CNPJ):</label>
            <div class="pix-input-container">
                <input type="text" id="chavePixInput" value="45.701.401/0001-07" readonly />
                
                <button onclick="copiarPix()" id="btnCopiarPix">
                    üìã Copiar
                </button>
            </div>

            <p><strong>Nome:</strong> Banco Cora (Col√©gio Antoni Gaudi)</p>
        <p style="margin-top: 25px; font-size: 0.95rem; color: #dc3545; font-weight: bold;">
            ‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> O pagamento deve ser confirmado no mesmo dia da reserva para garantir as mesas, ou a reserva ser√° liberada.
        </p>
        
        <button onclick="enviarWhatsapp()">
            üì≤ Enviar a reserva para o WhatsApp
        </button>
        </div>
    </div>
    <form id="formReserva">
        <label for="aluno">üéì Nome completo do Aluno:</label>
        <input type="text" id="aluno" required />

        <label for="turma">üìö Turma:</label>
    <select id="turma" required>
        <option value="">Selecione a turma</option>
        <option value="Maternal">Maternal</option>
        <option value="Grupo 1">Grupo 1</option>
        <option value="Grupo 2">Grupo 2</option>
        <option value="Grupo 3">Grupo 3</option>
        <option value="1¬∫ ano">1¬∫ ano</option>
        <option value="2¬∫ ano">2¬∫ ano</option>
        <option value="3¬∫ ano">3¬∫ ano</option>
        <option value="4¬∫ ano">4¬∫ ano</option>
        <option value="5¬∫ ano">5¬∫ ano</option>
        <option value="6¬∫ ano">6¬∫ ano</option>
        <option value="7¬∫ ano">7¬∫ ano</option>
        <option value="8¬∫ ano">8¬∫ ano</option>
        <option value="9¬∫ ano">9¬∫ ano</option>
        <option value="1¬™ s√©rie EM">1¬™ s√©rie (Ensino M√©dio)</option>
        <option value="2¬™ s√©rie EM">2¬™ s√©rie (Ensino M√©dio)</option>
        <option value="3¬™ s√©rie EM">3¬™ s√©rie (Ensino M√©dio)</option>
    </select>

        <label for="nome">üë§ Respons√°vel:</label>
        <input type="text" id="nome" required />
        
        <label for="telefone">üì± WhatsApp (Apenas n√∫meros com DDD):</label>
        <input type="tel" id="telefone" pattern="[0-9]{11,13}" required />

        <label for="cadeirasExtras">ü™ë Quantidade de Cadeiras Extras (R$ 10,00 cada, m√°x. 2):</label>
        <input type="number" id="cadeirasExtras" value="0" min="0" max="2" onchange="atualizarTotal()" />
        <div class="aviso">
            <strong>Aten√ß√£o: Limite de Cadeiras Extras!</strong> Devido √† limita√ß√£o de espa√ßo no sal√£o, o m√°ximo permitido √© de 2 cadeiras extras por reserva (total), independentemente do n√∫mero de mesas compradas. N√£o ser√° permitida a compra de cadeiras por terceiros para serem utilizadas em mesas que j√° atingiram o limite de 2. Por favor, respeitem as regras do evento para garantirmos uma festa linda e organizada para todos.
        </div>
        <div id="total">Total: R$ 0,00</div>
        <button type="submit">Reservar</button>
    </form>
    
    <div style="margin-top: 20px; text-align: center; max-width: 500px; width: 100%;">
        <button onclick="toggleCancelamentoForm()" style="
            background: none; 
            border: 1px solid #dc3545; 
            color: #dc3545; 
            padding: 10px 20px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 1rem;
            width: 100%;
            display: inline-block;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        ">Precisa Cancelar Sua Reserva? Clique Aqui</button>
    </div>
    
    <form id="formCancelamento" style="margin-top: 20px; max-width: 500px; width: 100%; display: none;">
        <h3 style="color: #f0f0f0;">Solicitar Cancelamento de Reserva</h3>
        <p style="font-size: 0.9rem; color: #ccc;">Para solicitar o cancelamento, <strong>confirme o nome e o telefone cadastrados</strong> e informe o n√∫mero de uma das mesas reservadas.</p>

        <label for="cancelamentoNome">üë§ Nome Completo do Respons√°vel (Exatamente como na reserva):</label>
        <input type="text" id="cancelamentoNome" required />

        <label for="cancelTelefone">üì± WhatsApp do Respons√°vel (Exatamente como na reserva):</label>
        <input type="tel" id="cancelTelefone" pattern="[0-9]{11,13}" required />

        <label for="cancelMesa">N√∫mero de uma Mesa Reservada (ex: 05):</label>
        <input type="text" id="cancelMesa" pattern="[0-9]{1,2}" required />

        <button type="submit" style="background: linear-gradient(145deg, #dc3545, #a02030); color: white;">Solicitar Cancelamento</button>
    </form>

    <script type="module">
        import { get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // Substitua os valores de configura√ß√£o do Firebase pelos seus reais se for rodar o c√≥digo.
        const firebaseConfig = {
            apiKey: "AIzaSyCmuuPAX68dOcESWMFdynI56j_GYkosEmg",
            authDomain: "reservas-tracos-culturais.firebaseapp.com",
            databaseURL: "https://reservas-tracos-culturais-default-rtdb.firebaseio.com",
            projectId: "reservas-tracos-culturais",
            storageBucket: "reservas-tracos-culturais.appspot.com",
            messagingSenderId: "53243907823",
            appId: "1:53243907823:web:1eee06470fe6554f0b551a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const reservas = {};
        const selecionadas = new Set();
        const totalMesas = 100;
        let bypassDuplicateCheck = false; // NOVO: Flag para ignorar a checagem de duplicidade na segunda tentativa

        const mesasContainer = document.getElementById("mesas");
        const form = document.getElementById("formReserva");
        const formCancelamento = document.getElementById("formCancelamento");
        const totalDiv = document.getElementById("total");
        const duplicateWarningDiv = document.getElementById("duplicateWarning"); 

        const VALOR_MESA = 150.00;
        const VALOR_CADEIRA = 10.00; 

        window.atualizarTotal = function() {
            let cadeirasExtras = parseInt(document.getElementById("cadeirasExtras")?.value) || 0;
            cadeirasExtras = Math.max(0, Math.min(2, cadeirasExtras)); 
            document.getElementById("cadeirasExtras").value = cadeirasExtras;

            const valorMesas = selecionadas.size * VALOR_MESA;
            const valorCadeiras = cadeirasExtras * VALOR_CADEIRA;
            
            const valor = valorMesas + valorCadeiras;
            totalDiv.textContent = `Total: R$ ${valor.toFixed(2).replace('.', ',')}`;
        }
        
        // Fun√ß√£o para normalizar strings (remove acentos, toUpperCase)
        function normalizeString(str) {
            if (!str) return '';
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
        }

        // Fun√ß√£o para exibir o aviso de duplicidade
        function showDuplicateWarning(reservaExistente) {
            const mesas = reservaExistente.mesasSelecionadas.join(", ");
            
            duplicateWarningDiv.innerHTML = `
                <h3>üö® ATEN√á√ÉO: Reserva J√° Feita! üö®</h3>
                <p>
                    O aluno <strong>${reservaExistente.aluno}</strong> j√° possui uma reserva ativa para as
                    <span style="color: #dc3545; font-weight: bold;">MESAS ${mesas}</span>.
                </p>
                <p>
                    A reserva foi feita por <strong>${reservaExistente.nome}</strong> no dia
                    ${reservaExistente.data} e est√° com o status 
                    <strong style="color: ${reservaExistente.status === 'paga' ? '#28a745' : '#d4af37'}">
                        ${reservaExistente.status.toUpperCase()}
                    </strong>.
                </p>
                <p>
                    Se voc√™ j√° pagou, ignore. Caso contr√°rio, confira os detalhes da reserva.
                    N√£o √© necess√°rio reservar novamente.
                </p>
                <button class="proceed-button" onclick="continueReservation()">
                    Deseja prosseguir com uma nova reserva para este aluno mesmo assim?
                </button>
            `;
            duplicateWarningDiv.style.display = 'block';
            duplicateWarningDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Oculta o formul√°rio de reserva 
            form.style.display = 'none';
        }
        
        // NOVO: Fun√ß√£o chamada pelo bot√£o "Deseja prosseguir"
        window.continueReservation = function() {
            bypassDuplicateCheck = true; // Define a flag para ignorar o check na pr√≥xima submiss√£o
            duplicateWarningDiv.style.display = 'none'; // Oculta o aviso
            form.style.display = 'block'; // Mostra o formul√°rio
            
            // For√ßa a re-submiss√£o do formul√°rio. 
            // O listener do form, agora, vai ignorar a checagem de duplicidade por causa da flag.
            form.requestSubmit(); 
        }


        function atualizarGrid() {
            // Garante que o container do mapa est√° vis√≠vel
            mesasContainer.style.display = 'grid'; 
            // O formul√°rio s√≥ aparece se n√£o houver aviso de duplicidade ativo
            if(duplicateWarningDiv.style.display !== 'block') {
                form.style.display = 'block'; 
            }
            
            mesasContainer.innerHTML = "";
            for (let i = 0; i < totalMesas; i++) {
                const posicao = i % 7; 

                // Adiciona um bloco vazio a cada 4 mesas para simular o corredor
                if (posicao === 4) { 
                    const espaco = document.createElement("div");
                    espaco.className = "mesa espaco";
                    mesasContainer.appendChild(espaco);
                }

                const numero = (i + 1).toString().padStart(2, '0');
                const div = document.createElement("div");
                div.className = "mesa";
                
                // === BLOCO: RESERVA ESPECIAL PARA A ESCOLA (Mesas 01, 02, 03, 04) ===
                const mesasDaEscola = ['01', '02', '03', '04'];
                if (mesasDaEscola.includes(numero)) {
                    div.textContent = 'MESA DA ESCOLA'; 
                    div.classList.add("reservada"); 
                    div.style.cursor = 'not-allowed';
                    div.title = 'Reservada para a Escola';
                    mesasContainer.appendChild(div);
                    continue; 
                }
                // ===================================================

                // Conte√∫do padr√£o para as outras mesas: "Mesa 05", "Mesa 06", etc.
                div.textContent = `Mesa ${numero}`;
                
                if (reservas[numero]) {
                    const status = reservas[numero].status;
                    
                    if (status === 'cancelamento-solicitado') {
                        div.classList.add("cancelamento-solicitado");
                    } else {
                        div.classList.add("reservada");
                    }

                    div.title = `Reservado por: ${reservas[numero].aluno} - ${reservas[numero].turma} (Resp: ${reservas[numero].nome} | Status: ${status === 'paga' ? 'Paga' : status === 'cancelamento-solicitado' ? 'Cancelamento Solicitado' : 'Pendente'})`;
                    
                } else {
                    if (selecionadas.has(numero)) div.classList.add("selecionada");
                    div.addEventListener("click", () => {
                        // Se estiver selecionando, remove o aviso e mostra o formul√°rio
                        if (duplicateWarningDiv.style.display === 'block') {
                            duplicateWarningDiv.style.display = 'none';
                            form.style.display = 'block';
                        }
                        
                        if (selecionadas.has(numero)) selecionadas.delete(numero);
                        else selecionadas.add(numero);
                        atualizarGrid();
                        atualizarTotal(); 
                    });
                }

                mesasContainer.appendChild(div);
            }
        }

        onValue(ref(db, "reservas"), (snapshot) => {
            Object.assign(reservas, snapshot.val() || {});
            atualizarGrid();
            atualizarTotal();
        });

        
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            // Oculta o aviso de duplicidade no in√≠cio da submiss√£o
            duplicateWarningDiv.style.display = 'none';
            form.style.display = 'block';

            const aluno = document.getElementById("aluno").value;
            const turma = document.getElementById("turma").value;
            const nome = document.getElementById("nome").value;
            const telefone = document.getElementById("telefone").value.replace(/[^0-9]/g, ''); 
            let cadeirasExtras = parseInt(document.getElementById("cadeirasExtras").value) || 0;
            cadeirasExtras = Math.max(0, Math.min(2, cadeirasExtras)); 
            
            // =======================================================
            // NOVO: BLOCO DE CHECAGEM DE DUPLICIDADE (IGNORA SE FLAG ESTIVER ATIVA)
            if (!bypassDuplicateCheck) { 
                const alunoNormalized = normalizeString(aluno);
                let existingReservation = null;

                for (const mesa in reservas) {
                    const reserva = reservas[mesa];
                    if (reserva.aluno && normalizeString(reserva.aluno) === alunoNormalized && reserva.status !== 'cancelamento-solicitado') {
                        // Encontrou uma reserva ativa ou pendente para este aluno.
                        existingReservation = reserva;
                        break;
                    }
                }

                if (existingReservation) {
                    // Mostra o aviso grande e para o processo
                    showDuplicateWarning(existingReservation);
                    return;
                }
            } else {
                // Se a flag estava ativa (segunda tentativa), reseta ela e prossegue
                bypassDuplicateCheck = false; 
            }
            // =======================================================


            const mesasSelecionadas = Array.from(selecionadas);

            if (mesasSelecionadas.length === 0) {
                alert("Voc√™ precisa selecionar pelo menos uma mesa.");
                return;
            }

            const jaReservadas = mesasSelecionadas.filter(m => reservas[m]);
            if (jaReservadas.length > 0) {
                alert("Mesas j√° reservadas: " + jaReservadas.join(", "));
                return;
            }

            const agora = new Date();
            
            const valorMesas = mesasSelecionadas.length * VALOR_MESA;
            const valorCadeiras = cadeirasExtras * VALOR_CADEIRA;
            const valorTotal = valorMesas + valorCadeiras; 
            
            const dataFormatada = agora.toLocaleDateString('pt-BR');
            const horarioFormatado = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });


            for (const mesa of mesasSelecionadas) {
                await set(ref(db, `reservas/${mesa}`), {
                    aluno,
                    turma,
                    nome,
                    telefone,
                    cadeirasExtras, 
                    valorTotal,
                    mesasSelecionadas,
                    horario: horarioFormatado,
                    data: dataFormatada,
                    status: 'pendente' 
                });
            }

            mostrarModalPix(valorTotal, aluno, turma, nome, mesasSelecionadas, telefone, cadeirasExtras); 

            selecionadas.clear();
            form.reset();
            atualizarTotal();
        });

        // Fun√ß√£o para exibir/ocultar o formul√°rio de cancelamento
        window.toggleCancelamentoForm = function() {
            if (formCancelamento.style.display === 'none' || formCancelamento.style.display === '') {
                formCancelamento.style.display = 'block';
                // Rola a p√°gina para o formul√°rio
                formCancelamento.scrollIntoView({ behavior: 'smooth', block: 'start' }); 
            } else {
                formCancelamento.style.display = 'none';
            }
        }

        // Listener para o formul√°rio de cancelamento
        formCancelamento.addEventListener("submit", async (e) => {
            e.preventDefault();
            const mesaInput = document.getElementById("cancelMesa").value.padStart(2, '0');
            const telefoneInput = document.getElementById("cancelTelefone").value.replace(/[^0-9]/g, '');
            const nomeInput = document.getElementById("cancelamentoNome").value; 

            if (!reservas[mesaInput]) {
                alert(`‚ùå Erro: A Mesa ${mesaInput} n√£o est√° registrada como reservada.`);
                return;
            }

            const reservaBase = reservas[mesaInput];
            
            // Coleta o grupo de mesas
            const mesasParaCancelar = reservaBase.mesasSelecionadas; 

            if (!mesasParaCancelar || mesasParaCancelar.length === 0) {
                alert('‚ùå Erro interno: N√£o foi poss√≠vel identificar o grupo de mesas.');
                return;
            }

            const confirmacao = confirm(`Tem certeza que deseja solicitar o cancelamento da reserva das Mesas ${mesasParaCancelar.join(', ')}? Esta a√ß√£o ser√° enviada para aprova√ß√£o da secretaria.`);

            if (!confirmacao) return;

            try {
                const updates = {};
                // Atualiza o status para todas as mesas do grupo
                mesasParaCancelar.forEach(mesa => {
                    updates[`/reservas/${mesa}/status`] = 'cancelamento-solicitado';
                    updates[`/reservas/${mesa}/solicitacaoCancelamento`] = new Date().toLocaleString('pt-BR');
                    // CAMPOS DE IDENTIDADE: ESSENCIAIS para passar na regra de seguran√ßa do Firebase
                    updates[`/reservas/${mesa}/nome`] = nomeInput; 
                    updates[`/reservas/${mesa}/telefone`] = telefoneInput; 
                });
                
                await update(ref(db), updates);

                alert(`‚úÖ Solicita√ß√£o de cancelamento registrada com sucesso para as Mesas ${mesasParaCancelar.join(', ')}.\n\nAguarde a aprova√ß√£o e contato da secretaria para o estorno, se houver.`);
                formCancelamento.reset();
                formCancelamento.style.display = 'none';
                
                // Notifica√ß√£o (para o ADM)
                enviarNotificacaoAdminCancelamento(reservaBase, mesasParaCancelar);

            } catch (error) {
                // Captura o erro do Firebase caso a regra de seguran√ßa n√£o seja satisfeita (Nome/Telefone Incorretos)
                if (error.message.includes('permission_denied')) {
                    alert("‚ùå Erro de Permiss√£o: O nome e/ou telefone fornecidos n√£o correspondem √† reserva da Mesa " + mesaInput + ". Verifique se digitou os dados cadastrados.");
                } else {
                        alert(`‚ùå Erro ao solicitar cancelamento: ${error.message}`);
                }
                console.error("Firebase Error:", error);
            }
        });

        // Fun√ß√£o para enviar uma notifica√ß√£o ao administrador via WhatsApp
        function enviarNotificacaoAdminCancelamento(reserva, mesas) {
            const mensagem = `
ALERTA: SOLICITA√á√ÉO DE CANCELAMENTO üö®
---
Respons√°vel: ${reserva.nome}
Telefone: ${reserva.telefone}
Aluno/Turma: ${reserva.aluno} (${reserva.turma})
Mesas: ${mesas.join(', ')}
Status Atual: ${reserva.status.toUpperCase()}
A√á√ÉO NECESS√ÅRIA: Verifique o painel de gest√£o para aprovar/rejeitar e processar o estorno.
            `.trim().replace(/\n/g, '%0A');

            const numeroFinanceiro = '5571999183320'; // N√∫mero do ADM/Financeiro
            window.open(`https://wa.me/${numeroFinanceiro}?text=${mensagem}`, '_blank');
        }
        
        // FUN√á√ÉO PARA COPIAR PIX
        window.copiarPix = function() {
            const input = document.getElementById("chavePixInput");
            const btn = document.getElementById("btnCopiarPix");

            input.select();
            input.setSelectionRange(0, 99999); 

            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(input.value)
                        .then(() => {
                            btn.textContent = '‚úÖ Copiado!';
                            setTimeout(() => { btn.textContent = 'üìã Copiar'; }, 2000);
                        })
                        .catch(err => {
                            document.execCommand("copy");
                            btn.textContent = '‚úÖ Copiado!';
                            setTimeout(() => { btn.textContent = 'üìã Copiar'; }, 2000);
                        });
                } else {
                    document.execCommand("copy");
                    btn.textContent = '‚úÖ Copiado!';
                    setTimeout(() => { btn.textContent = 'üìã Copiar'; }, 2000);
                }
            } catch (err) {
                alert('N√£o foi poss√≠vel copiar a chave Pix automaticamente. Por favor, copie manualmente: ' + input.value);
                console.error('Falha ao copiar: ', err);
            }
        }

        let mensagemWhatsApp = "";
        
        // FUN√á√ÉO mostrarModalPix 
        window.mostrarModalPix = function(valor, aluno, turma, nome, mesasSelecionadas, telefone, cadeirasExtras) {
            document.getElementById("pixValor").innerText = `R$ ${valor.toFixed(2).replace('.', ',')}`;
            
            const detalheCadeiras = cadeirasExtras > 0 ? ` (+ ${cadeirasExtras} Cadeira(s) Extra(s))` : '';
            
            mensagemWhatsApp = `NOVA RESERVA PIX (Festa da Fam√≠lia)%0A%0AAluno: ${aluno}%0ATurma: ${turma}%0ARespons√°vel: ${nome}%0ATelefone: ${telefone}%0AMesas: ${mesasSelecionadas.join(", ")} ${detalheCadeiras}%0AValor Total: R$ ${valor.toFixed(2).replace('.', ',')}%0A%0ACHAVE PIX CNPJ: 45.701.401/0001-07%0ANome: Cora (Col√©gio Antoni Gaudi)%0A%0A‚ö†Ô∏è ATEN√á√ÉO: Pagamento deve ser feito no mesmo dia da reserva para garantir as mesas, ou a reserva ser√° liberada.`;

            document.getElementById("pixModal").style.display = "flex";
        }

        window.fecharModal = function() {
            document.getElementById("pixModal").style.display = "none";
        }

        window.enviarWhatsapp = function() {
            // Abre no WhatsApp para o n√∫mero de destino do ADM (71999183320)
            window.open(`https://wa.me/5571999183320?text=${mensagemWhatsApp}`, '_blank');
        };
        
        atualizarTotal();
        
    </script>
</body>
</html>

